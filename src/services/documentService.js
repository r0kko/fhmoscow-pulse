import PDFDocument from 'pdfkit';

import { User, Sex } from '../models/index.js';
import ServiceError from '../errors/ServiceError.js';
import { applyFonts, applyFirstPageHeader } from '../utils/pdf.js';

async function generatePersonalDataConsent(userId) {
  const user = await User.findByPk(userId, { include: [Sex] });
  if (!user) throw new ServiceError('user_not_found', 404);
  const doc = new PDFDocument({ margin: 30, size: 'A4' });
  const { regular } = applyFonts(doc);
  applyFirstPageHeader(doc);
  doc.font(regular);
  doc
    .fontSize(14)
    .text('Согласие на обработку персональных данных', { align: 'center' });
  doc.moveDown();

  const paragraphs = [
    'Я, ____________________________________________________ (фамилия, имя, отчество полностью), дата рождения «___» __________ ____ г., место рождения ____________________, паспорт: серия ____ № _______, выдан ____________________________ «___» __________ ____ г., зарегистрирован(а) по адресу: ________________________________________________, настоящим свободно, своей волей и в своём интересе даю своё согласие РОО «Федерация хоккея Москвы», ОГРН ____________, ИНН ____________, расположенной по адресу: 101000, г. Москва, Кривоколенный пер., д. 9, стр. 1 (далее – Оператор), на обработку моих персональных данных в соответствии с нижеизложенными условиями.',
    'Мои персональные данные предоставляются Оператору в целях обеспечения моего участия в деятельности Федерации хоккея Москвы в качестве хоккейного судьи, включая, но не ограничиваясь:',
    '• организацией и проведением хоккейных матчей и соревнований с моим участием в качестве судьи (включая формирование заявок, назначение на матчи, подготовку и публикацию протоколов игр);',
    '• организацией и проведением учебно-методических мероприятий (семинаров, учебно-методических объединений) и тренировочных сборов для судей, контроля посещаемости и результатов обучения;',
    '• проверкой и оценкой моих знаний и навыков, приёмом экзаменов и зачётов, оформлением документов о сдаче нормативов (физической, теоретической подготовки) в рамках требований КТСС;',
    '• присвоением, подтверждением и учетом моей спортивной судейской квалификационной категории (разряда) в соответствии с КТСС и иными нормативами (включая подготовку представлений и приказов о присвоении категории);',
    '• ведением реестра судей и статистики по судейской деятельности, учетом стажа и опыта судейства, анализом работы судей для принятия кадровых и организационных решений;',
    '• исполнением Оператором своих уставных целей и обязанностей в сфере развития хоккея и подготовки судей, выполнения требований законодательства РФ о физической культуре и спорте;',
    '• обеспечением моей аккредитации и допуска к соревнованиям (включая проверку медицинских допусков, страховых полисов и других документов);',
    '• информированием меня о запланированных мероприятиях, сборах, изменениях в регламентах, а также рассылкой иной служебной информации, связанной с осуществлением мной функций судьи по хоккею с шайбой.',
    'Я предоставляю Оператору и разрешаю обрабатывать следующие мои персональные данные (в объёме, необходимом для достижения указанных целей):',
    '• Идентификационные данные: фамилия, имя, отчество; число, месяц, год рождения; место рождения; гражданство;',
    '• Документ, удостоверяющий личность: серия, номер паспорта; дата выдачи; наименование выдавшего органа; код подразделения (если имеется);',
    '• Адреса и контакты: адрес регистрации по месту жительства; адрес фактического проживания (при необходимости); контактный телефон; адрес электронной почты;',
    '• Дополнительные идентификаторы: страховой номер индивидуального лицевого счета (СНИЛС); индивидуальный номер налогоплательщика (ИНН);',
    '• Образование и квалификация: сведения об образовании (наименование учебного заведения, год окончания, специальность); сведения о пройдённых мною курсах, семинарах, учебно-методических сборах, в том числе для судей по хоккею с шайбой; дата и результаты сдачи теоретических и практических экзаменов (квалификационных зачётов) для судей;',
    '• Спортивная деятельность и опыт: спортивное звание/разряд (если имеется), спортивное прошлое; квалификационная категория спортивного судьи; дата присвоения и номер приказа о присвоении текущей категории; спортивные соревнования, в которых я принимал(а) участие в качестве судьи (перечень или стаж судейства); статистические показатели моей судейской деятельности (количество обслуженных матчей, замечания/оценки со стороны инспекторов соревнований и другие метрики);',
    '• Физическая подготовка и медобеспечение: результаты сдачи нормативов по физической подготовке (в том числе протоколы тестирования – беговые тесты, тест Купера и др.); сведения о состоянии здоровья, необходимые для допуска к судейской деятельности – включая данные медицинского освидетельствования (справки о годности к судейству, отсутствие медицинских противопоказаний, заключения врачей спортивной медицины и т.п.); сведения о страховом полисе от несчастных случаев, в том числе в целях его оформления;',
    '• Фотография и видео: мои фотографические изображения (цифровые фотографии, в том числе на удостоверениях судьи или аккредитационных бейджах); видеозаписи с моим участием, сделанные в рамках соревнований или учебных мероприятий (например, видеоразбор игровых моментов с семинаров);',
    '• Прочие данные: иные персональные данные, сообщённые мною Оператору в рамках выполнения функций судьи или необходимые Оператору для достижения указанных целей обработки (например, банковские реквизиты для перечисления вознаграждения за судейство; реквизиты договоров гражданско-правового характера; сведения об отсутствии судимости, сведения о транспортных средствах в собственности или аренде',
    'Я предоставляю Оператору право осуществлять с моими персональными данными следующие действия (операции): сбор, запись, систематизацию, накопление, хранение (в том числе включение в электронные базы данных и реестры Оператора), уточнение (обновление, изменение при необходимости), извлечение, использование, передачу (предоставление, распространение, доступ), обезличивание, блокирование, удаление, уничтожение моих персональных данных.',
    'Обработка персональных данных может осуществляться как автоматизированным способом (в информационных системах Федерации хоккея Москвы), так и неавтоматизированным способом (на бумажных носителях). В рамках выполнения указанных действий мои данные могут быть внесены в информационно-аналитические системы хоккейных организаций (включая реестры Федерации хоккея России или Министерства спорта РФ).',
    'Оператор вправе поручить обработку моих персональных данных третьим лицам с соблюдением требований законодательства о персональных данных (например, другим организациям или лицам, оказывающим Оператору услуги по сопровождению информационных систем, проведению соревнований или обучающих мероприятий). В таких случаях Оператор заключает с этими лицами договор, обязывающий соблюдать конфиденциальность и обеспечивать безопасность моих персональных данных.',
    'Я даю своё согласие на передачу (предоставление) моих персональных данных третьим лицам в следующих случаях:',
    '• компетентным организациям и органам в сфере спорта: в Федерацию хоккея России (ФХР) и ее структурные подразделения (например, Всероссийскую коллегию судей) – для учёта меня в единой базе спортивных судей, подтверждения моей категории, допуска к всероссийским соревнованиям и пр.; в Министерство спорта РФ или уполномоченные региональные органы управления спортом – для оформления приказов о присвоении судейской категории, статистической отчётности и иных предусмотренных законом процедур;',
    '• оргкомитетам и организаторам соревнований, спортивным клубам – в части, необходимой для моего допуска и аккредитации на конкретные соревнования (например, передача Ф.И.О. и категории судьи в заявку турнира, проверка в списках аккредитованных лиц);',
    '• страховым компаниям – при наступлении страхового случая на соревнованиях или оформления полиса (передача данных в пределах, необходимых для оформления страховых выплат по полису, если такой полис имеется у судьи);',
    '• службам экстренной помощи и медицины – в случае, если при исполнении обязанностей судьи возникнет необходимость сообщить мои данные (например, передача врачам информации о группе крови или медицинском допуске при чрезвычайной ситуации).',
    'Все указанные передачи осуществляются ограниченному кругу лиц в рамках исполнения моих функций судьи. Оператор обязуется не передавать мои данные третьим лицам, не указанным в согласии, за исключением случаев, предусмотренных законодательством РФ.',
    'Распространение (обнародование) персональных данных. Отдельно я даю согласие на распространение (обнародование) определённых моих персональных данных, разрешённых мною для распространения. А именно, согласен(на) на размещение следующих сведений в открытых источниках, включая официальный сайт Федерации хоккея Москвы, официальные аккаунты Федерации в социальных сетях (например, ВКонтакте и Telegram), а также печатные и электронные средства массовой информации:',
    '• фамилия, имя, отчество;',
    '• спортивная судейская категория (разряд) и звание;',
    '• город (регион) проживания;',
    '• фотография (портретное фото).',
    'Указанные данные могут публиковаться в составе списков судей, программ соревнований, новостных материалов о судьях, протоколов матчей (в разделе «Судейская бригада») и иных подобных сведений, связанных с популяризацией хоккея и информированием спортивной общественности. Я подтверждаю, что мне известно: распространение этих данных означает их доступ неограниченному кругу лиц, и я даю на это отдельное согласие. При этом я не устанавливаю каких-либо дополнительных условий или запретов на обработку (распространение) указанных персональных данных. Настоящее согласие на распространение действует до его отдельного отзыва.',
    'Настоящее согласие действует со дня его подписания и до истечения 50 (пятидесяти) лет со дня прекращения моей деятельности в качестве судьи, либо до дня его отзыва мною (что наступит раньше). Таким образом, срок действия согласия является максимальным возможным, с учетом целей обработки: мои персональные данные могут обрабатываться Оператором на протяжении всего срока, необходимого для достижения указанных целей, а именно в течение срока моего сотрудничества с Федерацией в качестве судьи, а также дополнительного периода после этого для хранения информации в архивных и статистических целях, если это требуется Оператору или предусмотрено нормативными документами.',
    'Я информирован(а), что законодательство РФ предусматривает хранение согласий на обработку персональных данных не менее 3 лет после отзыва или истечения срока их действия , и Оператор вправе сохранить копию настоящего согласия с моей подписью в своих архивах.',
    'Мне известно, что я могу в любое время отозвать настоящее согласие, направив Оператору соответствующее заявление. Отзыв согласия не требует обоснования с моей стороны. Для отзыва согласия я могу направить письменное заявление об отзыве собственноручно, на бумажном носителе, по адресу местонахождения Оператора: 101000, г. Москва, Кривоколенный пер., д. 9, стр. 1. Заявление может быть передано лично (под подпись уполномоченного представителя Оператора) или отправлено почтовым отправлением с уведомлением;',
    'Оператор прекращает обработку моих персональных данных не позднее чем в течение 30 дней с момента получения отзыва (за исключением хранения обезличенных статистических данных или случаев, когда обработка без согласия допускается законом). Оператор также уведомит меня о прекращении обработки по моему запросу. Я ознакомлен(а) с тем, что отзыв согласия не имеет обратной силы и не затрагивает законность обработки, осуществлённой до получения отзыва.',
    'Мне разъяснены права, предусмотренные законом «О персональных данных», в том числе право потребовать уточнения моих данных, их блокирования или уничтожения в случае их неполноты, устаревания или незаконной обработки, а также право на получение информации о своих персональных данных и факте их обработки (ст. 14 Федерального закона № 152-ФЗ). Я уведомлён(а), что в случае моего обращения с запросом о состоянии обработки моих персональных данных Оператор обязан предоставить соответствующие сведения в течение 30 дней. Контактные данные Оператора для запросов субъектов: тел. 8 (495) 621-35-95, e-mail: fhmoscow@mail.ru.',
    'Своими действиями по подписанию настоящего документа (в том числе проставлением простой электронной подписи в сервисе «Контур.Сайн») я подтверждаю, что внимательно прочитал(а) и понял(а) содержание данного согласия и согласен(на) с его условиями. Настоящее согласие подписано мной свободно, своей волей и в своём интересе.',
  ];

  doc.fontSize(11);
  paragraphs.forEach((p) => {
    doc.text(p, { align: 'justify' });
    doc.moveDown();
  });

  doc.moveDown();
  doc.text('Подпись: ______________________', { align: 'right' });
  doc.moveDown();
  doc.text('Дата: ______________________', { align: 'right' });

  const chunks = [];
  return new Promise((resolve, reject) => {
    doc.on('data', (c) => chunks.push(c));
    doc.on('end', () => resolve(Buffer.concat(chunks)));
    doc.on('error', reject);
    doc.end();
  });
}

export default { generatePersonalDataConsent };
